{% extends 'base.html.twig' %}
{% block title %}Panier{% endblock %}
{% block container %}
<style>
  .example-wrapper {
    margin: 1em auto;
    max-width: 800px;
    width: 95%;
    font: 18px/1.5 sans-serif;
  }
  .example-wrapper code {
    background: #f5f5f5;
    padding: 2px 6px;
  }
</style>

<div class="example-wrapper">
  <h1>Panier</h1>

  {% if panierProducts is not empty %}
  {% set total = 0 %}

  <table class="table">
    <thead>
      <tr>
        <th>Produit</th>
        <th>Quantité</th>
        <th>Prix</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody>
      {% for panierProduct in panierProducts %}
      {% set product = panierProduct.product %}
      <tr>
        <td>{{ product.name }}</td>
        <td>
          <div class="input-group">
            <input
              type="number"
              min="1"
              max="100"
              value="{{ panierProduct.quantity }}"
              class="form-control quantity-input"
              data-id="{{ product.id }}"
              data-price="{{ product.prix }}"
            />
            <button class="btn btn-primary update-quantity-btn" data-id="{{ product.id }}">Valider</button>
          </div>
        </td>
        <td>{{ product.prix }}€</td>
        <td class="product-total" data-id="{{ product.id }}">{{ product.prix * panierProduct.quantity }}€</td>
      </tr>
      {% set total = total + product.prix * panierProduct.quantity %}
      {% endfor %}
      <tr>
        <td colspan="3">Total:</td>
        <td id="cart-total">{{ total }}€</td>
      </tr>
    </tbody>
  </table>
  {% else %}
  <p>Votre panier est vide.</p>
  {% endif %}
</div>
{% endblock %}
{% block javascript %}
<script>
  document.querySelectorAll(".update-quantity-btn").forEach(function (button) {
    button.addEventListener("click", function () {
      var id = button.getAttribute("data-id");
      var input = document.querySelector(".quantity-input[data-id='" + id + "']");
      var quantity = parseInt(input.value);
      var pricePerProduct = parseFloat(input.getAttribute("data-price"));

      // Envoyer une requête AJAX pour mettre à jour la quantité
      var formData = new FormData();
      formData.append("productId", id);
      formData.append("quantity", quantity);

      fetch("/panier/update-quantity", {
        method: "POST",
        body: formData,
      })
        .then(function (response) {
          if (response.ok) {
            // Mise à jour réussie, effectuez les autres modifications nécessaires ici
            var productTotalElement = document.querySelector(".product-total[data-id='" + id + "']");
            productTotalElement.textContent = (pricePerProduct * quantity).toFixed(2) + "€";
            updateTotal();
          } else {
            // Gérer les erreurs de mise à jour ici
          }
        })
        .catch(function (error) {
          console.error(
            "Une erreur s'est produite lors de la mise à jour de la quantité :",
            error
          );
        });
    });
  });

  function updateTotal() {
    var total = 0;
    var productTotals = document.querySelectorAll(".product-total");
    for (var i = 0; i < productTotals.length; i++) {
      total += parseFloat(productTotals[i].textContent);
    }
    var updateTotalButton = document.querySelector("#cart-total");
    updateTotalButton.textContent = total.toFixed(2) + "€";
  }
</script>
{% endblock %}

